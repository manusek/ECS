name: Terraform Pipeline

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: cloudforge-ecr

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Assume Plan Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::100403449592:role/TerraformPlanRolev2
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Format
        run: terraform fmt -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Install TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
        working-directory: ./

      - name: Run TFLint
        run: tflint --init && tflint
        working-directory: ./

  plan:
    runs-on: ubuntu-latest
    needs: init
    steps:
      - uses: actions/checkout@v4

      # login to AWS with limited role
      - name: Assume Plan Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::100403449592:role/TerraformPlanRolev2
          aws-region: ${{ env.AWS_REGION }}

      # build docker image
      - name: Build Docker Image
        run: docker build -t app ./PycharmProjects/PythonProject/
      # ECR login
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin 100403449592.dkr.ecr.eu-central-1.amazonaws.com

      # tag + push
      - name: Push image
        run: |
          docker tag app:latest 100403449592.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest
          docker push 100403449592.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest

      # terraform plan â†’ artifact
      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

  apply:
    runs-on: ubuntu-latest
    needs: plan
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      # assume APPLY role (full permissions)
      - name: Assume Apply Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::100403449592:role/TerraformApplyRolev2
          aws-region: ${{ env.AWS_REGION }}

      - name: Download tfplan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan